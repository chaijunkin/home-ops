name: Deploy to Fly

on:
  workflow_dispatch: {}
  push:
    branches:
      - main
    paths:
      - infrastructure/flyio/vaultwarden/Dockerfile
      - infrastructure/flyio/vaultwarden/fly.toml
      - infrastructure/flyio/vaultwarden/config/**
      - infrastructure/flyio/vaultwarden/scripts/**
      - infrastructure/flyio/gatus/Dockerfile
      - infrastructure/flyio/gatus/fly.toml
      - infrastructure/flyio/gatus/config/**
      - infrastructure/flyio/gatus/gatus/**

jobs:
  # check-fly-secret:
  #   runs-on: ubuntu-latest
  #   outputs:
  #     fly-secret-exists: ${{ steps.fly-secret-check.outputs.defined }}
  #   steps:
  #     - name: Check for Fly secrets availability
  #       id: fly-secret-check
  #       # perform secret check & put boolean result as an output
  #       shell: bash
  #       run: |
  #         if [ "${{ secrets.FLY_API_TOKEN }}" != '' ] && [ "${{ secrets.FLY_APP }}" != '' ]; then
  #           echo "defined=true" >> $GITHUB_OUTPUT;
  #         else
  #           echo "defined=false" >> $GITHUB_OUTPUT;
  #         fi

  filter_paths:
    name: Filter Changed Apps
    runs-on: ubuntu-latest
    outputs:
      changed_apps: ${{ steps.filter.outputs.changes }} # This output will be a JSON array of changed app names
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6
      - uses: dorny/paths-filter@de90cc6fb38fc0963ad72b210f1f284cd68cea36 # v3 # Use the paths-filter action
        id: filter
        with:
          # Define a mapping of friendly name (the app name) to path pattern
          filters: |
            vaultwarden:
              - 'infrastructure/flyio/vaultwarden/**'
            gatus:
              - 'infrastructure/flyio/gatus/**'

  deploy:
    name: Deploy Changed App(s)
    runs-on: ubuntu-latest
    needs: [filter_paths] # Dependency on the path filtering job
    if: needs.filter_paths.outputs.changed_apps != '[]' # Only run if changes are detected
    steps:
      - uses: actions/checkout@0c366fd6a839edf440554fa01a7085ccba70ac98
      - uses: superfly/flyctl-actions/setup-flyctl@master
        # with:
        #   version: 0.1.54
      - name: Install Task
        uses: arduino/setup-task@v1
        with:
          # renovate: datasource=github-releases depName=go-task/task
          version: 3.48.0
          repo-token: ${{ secrets.GITHUB_TOKEN }}
      - name: Install jq
        run: |
          sudo apt-get update -y && sudo apt-get install -y jq

      - name: Deploy only changed app(s)
        shell: bash
        env:
          FLY_APP_JSON: ${{ secrets.FLY_APP }}
          FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}
          # The output from the filter_paths job, containing names of changed apps (e.g., ["gatus"])
          CHANGED_APPS: ${{ needs.filter_paths.outputs.changed_apps }}
        run: |
          if [ -z "$FLY_API_TOKEN" ]; then
            echo "FLY_API_TOKEN is not set" >&2
            exit 1
          fi

          if [ -z "$FLY_APP_JSON" ]; then
            echo "FLY_APP secret is empty" >&2
            exit 1
          fi

          # 1. Parse the JSON list of changed app names from the 'filter_paths' job
          changed_app_names=$(echo "$CHANGED_APPS" | jq -r '.[]')
          if [ -z "$changed_app_names" ]; then
            echo "No relevant app paths were changed. Skipping deployment."
            exit 0
          fi

          # 2. Iterate over each CHANGED app name (e.g., vaultwarden, gatus)
          for app_name in $changed_app_names; do

            # 3. Use JQ to search the FLY_APP_JSON array for an object
            #    where the 'app_name' key matches the current $app_name,
            #    and extract its 'fly_app_name' value.
            fly_name=$(echo "$FLY_APP_JSON" | jq -r --arg app_name_key "$app_name" \
              '.[] | select(.app_name == $app_name_key) | .fly_app_name')

            if [ "$fly_name" != "null" ] && [ -n "$fly_name" ]; then
              echo "âœ… Deploying $app_name to Fly app"
              dir="infrastructure/flyio/$app_name"
              if [ -d "$dir" ]; then
                (cd "$dir" && flyctl deploy --remote-only -a "$fly_name")
              else
                echo "Warning: Directory $dir not found for app $app_name. Skipping."
              fi
            else
              echo "Warning: Could not find configuration for changed app '$app_name' in FLY_APP_JSON. Skipping."
            fi
          done
