---
version: "3"

includes:
  logs: logs.yaml

tasks:
  create:
    desc: Create a new Fly app [APP=required]
    requires:
      vars:
        - APP
    dir: infrastructure/flyio/{{.APP}}

    cmds:
      - |
        fly_app=$(fly apps create --generate-name 2>&1 | tee /dev/tty)
        echo $fly_app | awk -F 'New app created:\ ' '{print "\n# Fly app name\nFLY_APP="$2}' >> .config.env
    silent: true

  destroy:
    desc: Destroy a Fly app [APP=required]
    requires:
      vars:
        - APP
    dir: infrastructure/flyio/{{.APP}}

    cmds:
      - fly apps destroy {{.FLY_APP}}
  deploy:
    desc: Deploy a Fly app [APP=required]
    requires:
      vars:
        - APP
    dir: infrastructure/flyio/{{.APP}}

    cmds:
      - task: :secrets:set
      - fly deploy -a {{.FLY_APP}}
  ssh:
    desc: SSH into a Fly app [APP=required]
    requires:
      vars:
        - APP
    dir: infrastructure/flyio/{{.APP}}

    cmds:
      - fly ssh console -a {{.FLY_APP}}
