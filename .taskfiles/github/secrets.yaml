---
version: "3"

tasks:
  set:
    cmds:
      # - fly_token=$(fly auth token 2>&1)
      - |
        fly_token=$(fly auth token 2>&1)
        if ! command -v jq >/dev/null 2>&1; then
          echo "jq is required to build JSON; please install jq" >&2
          exit 1
        fi

        json=$(for d in infrastructure/flyio/*; do
          [ -f "$d/.config.env" ] || continue
          app=$(basename "$d")
          flyv=$(grep -E '^FLY_APP=' "$d/.config.env" | head -n1 | sed -E 's/^FLY_APP=(.*)/\1/' | tr -d '\r"')
          [ -n "$flyv" ] || continue
          jq -nc --arg app "$app" --arg fly "$flyv" '{app_name:$app,fly_app_name:$fly}'
        done | jq -s '.')

        gh secret set FLY_APP -b "$json"
        gh secret set FLY_API_TOKEN -b "$fly_token"
