---
# yaml-language-server: $schema=https://kubernetes-schemas.pages.dev/external-secrets.io/externalsecret_v1.json
apiVersion: external-secrets.io/v1
kind: ExternalSecret
metadata:
  name: terraform-vars
  namespace: flux-system
spec:
  refreshInterval: 1h
  secretStoreRef:
    kind: ClusterSecretStore
    name: bitwarden-fields
  target:
    name: terraform-secret
    template:
      engineVersion: v2
      data:
        # --- Shared ---
        public_domain: "cloudjur.com" # Hardcoded based on repo analysis

        # --- Authentik Core ---
        authentik_token: "{{ .AUTHENTIK_TOKEN }}"

        # --- Authentik Applications (Mandatory) ---
        grafana_id: "{{ .GRAFANA_CLIENT_ID }}"
        grafana_secret: "{{ .GRAFANA_CLIENT_SECRET }}"
        open_webui_id: "{{ .OPEN_WEBUI_CLIENT_ID }}"
        open_webui_secret: "{{ .OPEN_WEBUI_CLIENT_SECRET }}"

        # --- Google OAuth (Source) ---
        # MISSING: Add google_oauth_client_id/secret mapping below if found
        # oauth_client_id: "{{ .GOOGLE_OAUTH_CLIENT_ID }}"
        # oauth_client_secret: "{{ .GOOGLE_OAUTH_CLIENT_SECRET }}"

        # --- Authentik Applications (Optional/Defaults Null) ---
        headlamp_id: "{{ .HEADLAMP_CLIENT_ID }}"
        headlamp_secret: "{{ .HEADLAMP_CLIENT_SECRET }}"
        romm_id: "{{ .ROMM_OIDC_CLIENT_ID }}"
        romm_secret: "{{ .ROMM_OIDC_CLIENT_SECRET }}"
        karakeep_id: "{{ .KARAKEEP_OIDC_CLIENT_ID }}"
        karakeep_secret: "{{ .KARAKEEP_OIDC_CLIENT_SECRET }}"
        ocis_id: "{{ .OCIS_OIDC_CLIENT_ID }}"
        ocis_secret: "{{ .OCIS_OIDC_CLIENT_SECRET }}"
        # jellyfin_id: "{{ .JELLYFIN_OIDC_CLIENT_ID }}"
        # jellyfin_secret: "{{ .JELLYFIN_OIDC_CLIENT_SECRET }}"
        # vaultwarden_id: "{{ .VAULTWARDEN_OIDC_CLIENT_ID }}"
        # calibre_web_automated_id: "{{ .CALIBRE_OIDC_CLIENT_ID }}"

        # --- Minio ---
        minio_server: "https://s3.cloudjur.com"
        minio_user: "{{ .MINIO_ROOT_USER }}"
        minio_password: "{{ .MINIO_ROOT_PASSWORD }}"
        owner_access_key: "{{ .R2_ACCESS_KEY }}"
        owner_secret_key: "{{ .R2_ACCESS_SECRET }}"

  data:
    # Authentik Token (Item: f3fcbd57)
    - secretKey: AUTHENTIK_TOKEN
      sourceRef:
        storeRef:
          name: bitwarden-fields
          kind: ClusterSecretStore
      remoteRef:
        key: f3fcbd57-d2b1-48ae-acce-d3579d01ba33
        property: AUTHENTIK_BOOTSTRAP_TOKEN

    # Grafana (Item: b63d3bff)
    - secretKey: GRAFANA_CLIENT_ID
      sourceRef:
        storeRef:
          name: bitwarden-fields
          kind: ClusterSecretStore
      remoteRef:
        key: b63d3bff-0027-4779-8d0f-c70528bf98f8
        property: GRAFANA_CLIENT_ID
    - secretKey: GRAFANA_CLIENT_SECRET
      sourceRef:
        storeRef:
          name: bitwarden-fields
          kind: ClusterSecretStore
      remoteRef:
        key: b63d3bff-0027-4779-8d0f-c70528bf98f8
        property: GRAFANA_CLIENT_SECRET

    # Open-WebUI (Item: 3281c266)
    - secretKey: OPEN_WEBUI_CLIENT_ID
      sourceRef:
        storeRef:
          name: bitwarden-fields
          kind: ClusterSecretStore
      remoteRef:
        key: 3281c266-c631-42a0-bbed-db4429728cad
        property: open_webui_oauth_id
    - secretKey: OPEN_WEBUI_CLIENT_SECRET
      sourceRef:
        storeRef:
          name: bitwarden-fields
          kind: ClusterSecretStore
      remoteRef:
        key: 3281c266-c631-42a0-bbed-db4429728cad
        property: open_webui_oauth_secret

    # Headlamp (Item: 153f8e3f)
    - secretKey: HEADLAMP_CLIENT_ID
      sourceRef:
        storeRef:
          name: bitwarden-fields
          kind: ClusterSecretStore
      remoteRef:
        key: 153f8e3f-cf1d-4ac6-af96-b934baab3bc5
        property: client_id
    - secretKey: HEADLAMP_CLIENT_SECRET
      sourceRef:
        storeRef:
          name: bitwarden-fields
          kind: ClusterSecretStore
      remoteRef:
        key: 153f8e3f-cf1d-4ac6-af96-b934baab3bc5
        property: client_secret

    # Romm (Item: d0996f8e)
    - secretKey: ROMM_OIDC_CLIENT_ID
      sourceRef:
        storeRef:
          name: bitwarden-fields
          kind: ClusterSecretStore
      remoteRef:
        key: d0996f8e-5aa9-4501-9c84-ca88e9f543bd
        property: OIDC_CLIENT_ID
    - secretKey: ROMM_OIDC_CLIENT_SECRET
      sourceRef:
        storeRef:
          name: bitwarden-fields
          kind: ClusterSecretStore
      remoteRef:
        key: d0996f8e-5aa9-4501-9c84-ca88e9f543bd
        property: OIDC_CLIENT_SECRET

    # Karakeep (Item: e826e99b)
    - secretKey: KARAKEEP_OIDC_CLIENT_ID
      sourceRef:
        storeRef:
          name: bitwarden-fields
          kind: ClusterSecretStore
      remoteRef:
        key: e826e99b-cdf4-465a-a394-0b10e8bb01b8
        property: oauth_client_id
    - secretKey: KARAKEEP_OIDC_CLIENT_SECRET
      sourceRef:
        storeRef:
          name: bitwarden-fields
          kind: ClusterSecretStore
      remoteRef:
        key: e826e99b-cdf4-465a-a394-0b10e8bb01b8
        property: oauth_client_secret

    # OCIS/OpenCloud (Item: e62c9502)
    - secretKey: OCIS_OIDC_CLIENT_ID
      sourceRef:
        storeRef:
          name: bitwarden-fields
          kind: ClusterSecretStore
      remoteRef:
        key: e62c9502-0c7b-4908-a5fd-42d15e269e2d
        property: ocis_oauth_client_id
    - secretKey: OCIS_OIDC_CLIENT_SECRET
      sourceRef:
        storeRef:
          name: bitwarden-fields
          kind: ClusterSecretStore
      remoteRef:
        key: e62c9502-0c7b-4908-a5fd-42d15e269e2d
        property: ocis_oauth_client_id # Shared id for secret if not separate

    # Minio (Item: d10ce5c3)
    - secretKey: MINIO_ROOT_USER
      sourceRef:
        storeRef:
          name: bitwarden-login
          kind: ClusterSecretStore
      remoteRef:
        key: d10ce5c3-ce4b-4f22-9430-b962390e0cba
        property: username
    - secretKey: MINIO_ROOT_PASSWORD
      sourceRef:
        storeRef:
          name: bitwarden-login
          kind: ClusterSecretStore
      remoteRef:
        key: d10ce5c3-ce4b-4f22-9430-b962390e0cba
        property: password
    - secretKey: R2_ACCESS_KEY
      sourceRef:
        storeRef:
          name: bitwarden-fields
          kind: ClusterSecretStore
      remoteRef:
        key: d10ce5c3-ce4b-4f22-9430-b962390e0cba
        property: owner_access_key
    - secretKey: R2_ACCESS_SECRET
      sourceRef:
        storeRef:
          name: bitwarden-fields
          kind: ClusterSecretStore
      remoteRef:
        key: d10ce5c3-ce4b-4f22-9430-b962390e0cba
        property: owner_secret_key
