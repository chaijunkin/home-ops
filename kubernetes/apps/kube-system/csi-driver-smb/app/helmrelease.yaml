apiVersion: source.toolkit.fluxcd.io/v1
kind: OCIRepository
metadata:
  name: csi-driver-smb
spec:
  interval: 5m
  layerSelector:
    mediaType: application/vnd.cncf.helm.chart.content.v1.tar+gzip
    operation: copy
  url: oci://ghcr.io/home-operations/charts-mirror/csi-driver-smb
  ref:
    tag: 1.18.0
# ---
# apiVersion: source.toolkit.fluxcd.io/v1
# kind: HelmRepository
# metadata:
#   name: csi-driver-smb
#   namespace: flux-system
# spec:
#   interval: 1h
#   url: https://raw.githubusercontent.com/kubernetes-csi/csi-driver-smb/master/charts
---
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: csi-driver-smb
spec:
  interval: 30m
  maxHistory: 2
  install:
    remediation:
      retries: 3
  upgrade:
    cleanupOnFail: true
    remediation:
      retries: 3
  uninstall:
    keepHistory: false
  postRenderers:
    - kustomize:
        patches:
          - target:
              version: v1
              kind: Deployment
              name: csi-smb-controller
            patch: |
              apiVersion: apps/v1
              kind: Deployment
              metadata:
                name: csi-smb-controller
              spec:
                template:
                  spec:
                    containers:
                      - name: csi-resizer
                        $patch: delete
          - target:
              version: v1
              kind: DaemonSet
              name: csi-smb-node
            patch: |
              - op: replace
                path: /spec/template/spec/containers/2/args
                value:
                   - "--v=5"
                   - "--drivername=smb.csi.k8s.io"
                   - "--endpoint=$(CSI_ENDPOINT)"
                   - "--nodeid=$(KUBE_NODE_NAME)"
                   - "--enable-get-volume-stats=true"
  values:
    image:
      baseRepo: registry.k8s.io/sig-storage
      smb:
        repository: registry.k8s.io/sig-storage/smbplugin
        tag: v1.12.0
        pullPolicy: IfNotPresent
      csiProvisioner:
        repository: registry.k8s.io/sig-storage/csi-provisioner
        tag: v3.5.0
        pullPolicy: IfNotPresent
      livenessProbe:
        repository: registry.k8s.io/sig-storage/livenessprobe
        tag: v2.10.0
        pullPolicy: IfNotPresent
      nodeDriverRegistrar:
        repository: registry.k8s.io/sig-storage/csi-node-driver-registrar
        tag: v2.8.0
        pullPolicy: IfNotPresent
      csiproxy:
        repository: ghcr.io/kubernetes-sigs/sig-windows/csi-provisioner
        tag: v1.1.2
        pullPolicy: IfNotPresent
    serviceAccount:
      create: true
      controller: csi-smb-controller-sa
      node: csi-smb-node-sa
    rbac:
      create: true
      name: smb
    driver:
      name: smb.csi.k8s.io
    feature:
      enableGetVolumeStats: true
    controller:
      name: csi-smb-controller
      replicas: 1
      dnsPolicy: ClusterFirstWithHostNet
      metricsPort: 29644
      livenessProbe:
        healthPort: 29642
      runOnMaster: false
      runOnControlPlane: false
      logLevel: 5
      workingMountDir: /tmp
      resources:
        csiProvisioner:
          limits:
            memory: 300Mi
          requests:
            cpu: 10m
            memory: 20Mi
        livenessProbe:
          limits:
            memory: 100Mi
          requests:
            cpu: 10m
            memory: 20Mi
        smb:
          limits:
            memory: 200Mi
          requests:
            cpu: 10m
            memory: 20Mi
      affinity: {}
      # nodeSelector: {}
      tolerations:
        - key: node-role.kubernetes.io/master
          operator: Exists
          effect: NoSchedule
        - key: node-role.kubernetes.io/controlplane
          operator: Exists
          effect: NoSchedule
        - key: node-role.kubernetes.io/control-plane
          operator: Exists
          effect: NoSchedule
    node:
      maxUnavailable: 1
      logLevel: 5
      livenessProbe:
        healthPort: 29643
      affinity: {}
      nodeSelector: {}
    linux:
      enabled: true
      dsName: csi-smb-node
      dnsPolicy: ClusterFirstWithHostNet
      kubelet: /var/lib/kubelet
      krb5Prefix: "krb5cc2_"
      tolerations:
        - operator: Exists
      resources:
        livenessProbe:
          limits:
            memory: 100Mi
          requests:
            cpu: 10m
            memory: 20Mi
        nodeDriverRegistrar:
          limits:
            memory: 100Mi
          requests:
            cpu: 10m
            memory: 20Mi
        smb:
          limits:
            memory: 200Mi
          requests:
            cpu: 10m
            memory: 20Mi
    windows:
      enabled: false
      dsName: csi-smb-node-win
      kubelet: C:\var\lib\kubelet
      removeSMBMappingDuringUnmount: true
      tolerations:
        - key: node.kubernetes.io/os
          operator: Exists
          effect: NoSchedule
      resources:
        livenessProbe:
          limits:
            memory: 150Mi
          requests:
            cpu: 10m
            memory: 40Mi
        nodeDriverRegistrar:
          limits:
            memory: 150Mi
          requests:
            cpu: 10m
            memory: 40Mi
        smb:
          limits:
            memory: 200Mi
          requests:
            cpu: 10m
            memory: 40Mi
      csiproxy:
        enabled: false
        dsName: csi-proxy-win
        tolerations: {}
        affinity: {}
        nodeSelector:
          kubernetes.io/os: windows
    customLabels: {}
    podAnnotations: {}
    podLabels: {}
    priorityClassName: system-cluster-critical
    securityContext:
      seccompProfile:
        type: RuntimeDefault
  chartRef:
    kind: OCIRepository
    name: csi-driver-smb
  # chart:
  #   spec:
  #     chart: csi-driver-smb
  #     version: v1.12.0
  #     sourceRef:
  #       kind: HelmRepository
  #       name: csi-driver-smb
  #       namespace: flux-system
