# ---
# # yaml-language-server: $schema=https://raw.githubusercontent.com/fluxcd-community/flux2-schemas/refs/heads/main/gitrepository-source-v1.json
# apiVersion: source.toolkit.fluxcd.io/v1
# kind: GitRepository
# metadata:
#   name: multus-crd
# spec:
#   interval: 30m
#   url: https://github.com/k8snetworkplumbingwg/network-attachment-definition-client
#   ref:
#     tag: v1.7.7
#   ignore: |
#     # exclude
#     /*
#     # include
#     !artifacts/networks-crd.yaml
# ---
# # yaml-language-server: $schema=https://k8s-schemas.bjw-s.dev/kustomize.toolkit.fluxcd.io/kustomization_v1.json
# apiVersion: kustomize.toolkit.fluxcd.io/v1
# kind: Kustomization
# metadata:
#   name: multus-crd
# spec:
#   prune: false
#   sourceRef:
#     kind: GitRepository
#     name: multus-crd
#   wait: true
#   interval: 15m
#   retryInterval: 1m
#   timeout: 5m
# ---
# # yaml-language-server: $schema=https://raw.githubusercontent.com/bjw-s-labs/helm-charts/main/charts/other/app-template/schemas/helmrelease-helm-v2.schema.json
# apiVersion: helm.toolkit.fluxcd.io/v2
# kind: HelmRelease
# metadata:
#   name: multus
# spec:
#   interval: 30m
#   chartRef:
#     kind: OCIRepository
#     apiVersion: source.toolkit.fluxcd.io/v1beta2
#     name: app-template
#     namespace: flux-system
#   values:
#     controllers:
#       multus:
#         type: daemonset

#         pod:
#           hostNetwork: true
#           priorityClassName: system-node-critical
#           tolerations:
#             - key: CriticalAddonsOnly
#               operator: Exists

#         initContainers:
#           cni-plugins:
#             image:
#               repository: ghcr.io/home-operations/cni-plugins
#               tag: 1.7.1

#         containers:
#           multus:
#             image:
#               repository: ghcr.io/k8snetworkplumbingwg/multus-cni
#               tag: v4.2.2
#             args:
#               - --cleanup-config-on-exit
#               - --multus-cni-conf-dir=/tmp
#             resources:
#               requests:
#                 cpu: "10m"
#               limits:
#                 memory: "512Mi"
#             securityContext:
#               allowPrivilegeEscalation: false
#               readOnlyRootFilesystem: true
#               capabilities:
#                 add:
#                   - NET_ADMIN
#                 drop:
#                   - ALL

#     persistence:
#       etc-cni-net-d:
#         type: hostPath
#         hostPath: /etc/cni/net.d
#         globalMounts:
#           - path: /host/etc/cni/net.d
#       opt-cni-bin:
#         type: hostPath
#         hostPath: /opt/cni/bin
#         globalMounts:
#           - path: /host/opt/cni/bin
#       tmp:
#         type: emptyDir

#     rbac:
#       roles:
#         multus:
#           type: ClusterRole
#           rules:
#             - apiGroups:
#                 - "k8s.cni.cncf.io"
#               resources:
#                 - "*"
#               verbs:
#                 - "*"
#             - apiGroups:
#                 - ""
#               resources:
#                 - "pods"
#                 - "pods/status"
#               verbs:
#                 - "get"
#                 - "update"
#             - apiGroups:
#                 - ""
#                 - "events.k8s.io"
#               resources:
#                 - "events"
#               verbs:
#                 - "create"
#                 - "patch"
#                 - "update"
#       bindings:
#         multus:
#           type: ClusterRoleBinding
#           roleRef:
#             identifier: multus
#           subjects:
#             - identifier: multus

#     serviceAccount:
#       multus: {}

---
# yaml-language-server: $schema=https://raw.githubusercontent.com/fluxcd-community/flux2-schemas/main/helmrelease-helm-v2beta2.json
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: multus
spec:
  interval: 30m
  chart:
    spec:
      chart: multus
      version: 5.0.7
      sourceRef:
        kind: HelmRepository
        name: angelnu
        namespace: flux-system
      interval: 30m
  values:
    image:
      repository: ghcr.io/k8snetworkplumbingwg/multus-cni
      tag: v4.1.3-thick

    cni:
      image:
        repository: ghcr.io/angelnu/cni-plugins
        tag: 1.5.0

      paths:
        bin: /opt/cni/bin
        config: /etc/cni/net.d

    resources:
      requests:
        cpu: 5m
        # memory: 1024Mi
      limits:
        memory: 8192Mi

    hostPaths:
      netns: /var/run/netns
