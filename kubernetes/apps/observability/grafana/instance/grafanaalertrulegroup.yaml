---
apiVersion: grafana.integreatly.org/v1beta1
kind: GrafanaAlertRuleGroup
metadata:
  name: fly-app-alerts
spec:
  instanceSelector:
    matchLabels:
      grafana.internal/instance: grafana

  folderRef: "external-folder"
  interval: 1m
  name: "Fly App Monitoring"

  rules:
    - uid: fly-app-response-time
      title: "Fly App - High Response Time"
      condition: C
      data:
        - refId: A
          relativeTimeRange:
            from: 600
            to: 0
          datasourceUid: fly-io-prometheus
          model:
            expr: |
              histogram_quantile(0.95,
                sum by(app, status, le) (
                  rate(fly_app_http_response_time_seconds_bucket[5m])
                )
              )
            refId: A
        - refId: B
          datasourceUid: "-100"
          model:
            type: reduce
            refId: B
            expression: A
            reducer: last
        - refId: C
          datasourceUid: "-100"
          model:
            type: threshold
            refId: C
            expression: B
            conditions:
              - evaluator:
                  params: [5]
                  type: gt
      for: 5m
      noDataState: NoData
      execErrState: Alerting
      annotations:
        summary: "Response time exceeded 5 seconds"
        description: "95th percentile response time is {{ $values.A.Value }}s"
      labels:
        severity: critical
        alertname: HighResponseTime
        job: fly-app

    - uid: fly-app-error-rate
      title: "Fly App - High Error Rate"
      condition: D
      data:
        - refId: A
          relativeTimeRange:
            from: 600
            to: 0
          datasourceUid: fly-io-prometheus
          model:
            expr: |
              sum by(app) (
                rate(fly_app_http_responses_count{status=~"5.*"}[5m])
              )
            refId: A
        - refId: B
          relativeTimeRange:
            from: 600
            to: 0
          datasourceUid: fly-io-prometheus
          model:
            expr: |
              sum by(app) (
                rate(fly_app_http_responses_count[5m])
              )
            refId: B
        - refId: C
          datasourceUid: "-100"
          model:
            type: math
            refId: C
            expression: "(A / B) * 100"
        - refId: D
          datasourceUid: "-100"
          model:
            type: threshold
            refId: D
            expression: C
            conditions:
              - evaluator:
                  params: [5]
                  type: gt
      for: 5m
      noDataState: NoData
      execErrState: Alerting
      annotations:
        summary: "Error rate above 5%"
        description: "HTTP 5xx error rate exceeds threshold"
      labels:
        severity: critical
        alertname: HighErrorRate
        job: fly-app

    - uid: fly-app-memory-pressure
      title: "Fly App - Memory Pressure"
      condition: B
      data:
        - refId: A
          relativeTimeRange:
            from: 600
            to: 0
          datasourceUid: fly-io-prometheus
          model:
            expr: |
              fly_instance_memory_pressure_full{pressure_duration="avg60"}
            refId: A
        - refId: B
          datasourceUid: "-100"
          model:
            type: threshold
            refId: B
            expression: A
            conditions:
              - evaluator:
                  params: [50]
                  type: gt
      for: 10m
      noDataState: NoData
      execErrState: Alerting
      annotations:
        summary: "Memory pressure detected"
        description: "Memory pressure avg60 is high"
      labels:
        severity: warning
        alertname: HighMemoryPressure
        job: fly-app

    - uid: fly-app-instance-down
      title: "Fly App - Instance Down"
      condition: B
      data:
        - refId: A
          relativeTimeRange:
            from: 300
            to: 0
          datasourceUid: fly-io-prometheus
          model:
            expr: |
              fly_instance_up
            refId: A
        - refId: B
          datasourceUid: "-100"
          model:
            type: threshold
            refId: B
            expression: A
            conditions:
              - evaluator:
                  params: [1]
                  type: lt
      for: 1m
      noDataState: Alerting
      execErrState: Alerting
      annotations:
        summary: "Instance is down"
        description: "Fly instance unreachable"
      labels:
        severity: critical
        alertname: InstanceDown
        job: fly-app
