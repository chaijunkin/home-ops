---
apiVersion: grafana.integreatly.org/v1beta1
kind: GrafanaAlertRuleGroup
metadata:
  name: fly-app-http-alerts

spec:
  instanceSelector:
    matchLabels:
      grafana.internal/instance: grafana

  folderRef: "external-folder"
  interval: 1m
  name: "Fly App - HTTP & Application"

  rules:
    # Alert 1: HTTP 5xx Error Rate Spike
    - uid: fly-http-5xx-errors
      title: "HTTP 5xx Error Rate Spike"
      condition: C
      for: 5m
      noDataState: NoData
      execErrState: Alerting
      annotations:
        summary: "High rate of 5xx errors detected for {{ $labels.app }} instance {{ $labels.instance }}"
        description: "5xx error rate is {{ $values.C.Value | humanize }}/sec, which exceeds the threshold of 10/sec"
      #        __dashboardUid__: "fly-app"
      labels:
        severity: "critical"
        alertname: "HTTP5xxErrorSpike"
        team: "platform"
        service: "fly-io"
      data:
        - refId: A
          datasourceUid: prometheus_on_fly
          relativeTimeRange:
            from: 600
            to: 0
          model:
            expr: 'sum by(app, instance) (rate(fly_app_http_responses_count{status=~"5.."}[5m]))'
            refId: A
        - refId: B
          datasourceUid: __expr__
          model:
            type: reduce
            expression: A
            reducer: last
            refId: B
        - refId: C
          datasourceUid: __expr__
          model:
            type: threshold
            expression: B
            refId: C
            conditions:
              - evaluator:
                  params: [10]
                  type: gt
                operator:
                  type: and
                query:
                  params: [C]
                reducer:
                  type: last
                type: query

    # Alert 2: HTTP Response Time > 5s
    - uid: fly-http-response-time-5s
      title: "HTTP Response Time > 5s (Incident Threshold)"
      condition: C
      for: 5m
      noDataState: NoData
      execErrState: Alerting
      annotations:
        summary: "HTTP response time exceeds 5 seconds for {{ $labels.app }}"
        description: "P99 response time is {{ $values.C.Value | humanize }}s - Consider declaring an incident"
      #        __dashboardUid__: "fly-app"
      labels:
        severity: "critical"
        alertname: "HighResponseTimeP99"
        team: "platform"
        service: "fly-io"
        incident_threshold: "true"
      data:
        - refId: A
          datasourceUid: prometheus_on_fly
          relativeTimeRange:
            from: 600
            to: 0
          model:
            expr: "histogram_quantile(0.99, sum by(app, le) (rate(fly_app_http_response_time_seconds_bucket[5m])))"
            refId: A
        - refId: B
          datasourceUid: __expr__
          model:
            type: reduce
            expression: A
            reducer: last
            refId: B
        - refId: C
          datasourceUid: __expr__
          model:
            type: threshold
            expression: B
            refId: C
            conditions:
              - evaluator:
                  params: [5]
                  type: gt
                operator:
                  type: and
                query:
                  params: [C]
                reducer:
                  type: last
                type: query

    # Alert: High 5xx Error Rate (Percentage)
    - uid: fly-app-5xx-rate-pct
      title: "High 5xx Error Rate (Percentage)"
      condition: D
      for: 5m
      noDataState: NoData
      execErrState: Alerting
      annotations:
        summary: "HTTP 5xx error rate above 5%"
        description: "5xx error rate is {{ $values.D.Value | humanize }}% - Check recent deployments immediately"
      #        __dashboardUid__: "fly-app"
      labels:
        severity: "critical"
        alertname: "High5xxRate"
        team: "platform"
        service: "fly-io"
      data:
        - refId: A
          datasourceUid: prometheus_on_fly
          relativeTimeRange:
            from: 600
            to: 0
          model:
            expr: 'sum(increase(fly_app_http_responses_count{status=~"5.."}[5m]))'
            refId: A
        - refId: B
          datasourceUid: prometheus_on_fly
          relativeTimeRange:
            from: 600
            to: 0
          model:
            expr: "sum(increase(fly_app_http_responses_count[5m]))"
            refId: B
        - refId: C
          datasourceUid: __expr__
          model:
            type: math
            expression: "($A / $B) * 100"
            refId: C
        - refId: D
          datasourceUid: __expr__
          model:
            type: threshold
            expression: C
            refId: D
            conditions:
              - evaluator:
                  params: [5]
                  type: gt
                operator:
                  type: and
                query:
                  params: [D]
                reducer:
                  type: last
                type: query

    # Alert: High 4xx Client Error Rate
    - uid: fly-app-4xx-rate
      title: "High 4xx Client Error Rate"
      condition: D
      for: 10m
      noDataState: NoData
      execErrState: Alerting
      annotations:
        summary: "Client error rate exceeds 15%"
        description: "4xx error rate is {{ $values.D.Value | humanize }}% - Check for invalid requests or API changes"
      #        __dashboardUid__: "fly-app"
      labels:
        severity: "warning"
        alertname: "High4xxRate"
        team: "platform"
        service: "fly-io"
      data:
        - refId: A
          datasourceUid: prometheus_on_fly
          relativeTimeRange:
            from: 600
            to: 0
          model:
            expr: 'sum(increase(fly_app_http_responses_count{status=~"4.."}[5m]))'
            refId: A
        - refId: B
          datasourceUid: prometheus_on_fly
          relativeTimeRange:
            from: 600
            to: 0
          model:
            expr: "sum(increase(fly_app_http_responses_count[5m]))"
            refId: B
        - refId: C
          datasourceUid: __expr__
          model:
            type: math
            expression: "($A / $B) * 100"
            refId: C
        - refId: D
          datasourceUid: __expr__
          model:
            type: threshold
            expression: C
            refId: D
            conditions:
              - evaluator:
                  params: [15]
                  type: gt
                operator:
                  type: and
                query:
                  params: [D]
                reducer:
                  type: last
                type: query

    # Alert: High App Concurrency
    - uid: fly-app-high-concurrency
      title: "High App Concurrency"
      condition: C
      for: 5m
      noDataState: NoData
      execErrState: Alerting
      annotations:
        summary: "App concurrency is high"
        description: "Concurrency is {{ $values.C.Value | humanize }} - Consider scaling the application"
      #        __dashboardUid__: "fly-app"
      labels:
        severity: "warning"
        alertname: "HighConcurrency"
        team: "platform"
        service: "fly-io"
      data:
        - refId: A
          datasourceUid: prometheus_on_fly
          relativeTimeRange:
            from: 600
            to: 0
          model:
            expr: "sum(fly_app_concurrency) by (instance, region)"
            refId: A
        - refId: B
          datasourceUid: __expr__
          model:
            type: reduce
            expression: A
            reducer: last
            refId: B
        - refId: C
          datasourceUid: __expr__
          model:
            type: threshold
            expression: B
            refId: C
            conditions:
              - evaluator:
                  params: [100]
                  type: gt
                operator:
                  type: and
                query:
                  params: [C]
                reducer:
                  type: last
                type: query

    # Alert: Soft Limit Reached
    - uid: fly-soft-limit-reached
      title: "Soft Limit Reached Frequently"
      condition: C
      for: 5m
      noDataState: NoData
      execErrState: Alerting
      annotations:
        summary: "App soft concurrency limit reached"
        description: "Soft limit hit {{ $values.C.Value | humanize }} times in 5 minutes - Consider scaling"
      #        __dashboardUid__: "fly-app"
      labels:
        severity: "warning"
        alertname: "SoftLimitReached"
        team: "platform"
        service: "fly-io"
      data:
        - refId: A
          datasourceUid: prometheus_on_fly
          relativeTimeRange:
            from: 600
            to: 0
          model:
            expr: "sum by(app, instance) (increase(fly_app_soft_limit_reached_count[5m]))"
            refId: A
        - refId: B
          datasourceUid: __expr__
          model:
            type: reduce
            expression: A
            reducer: last
            refId: B
        - refId: C
          datasourceUid: __expr__
          model:
            type: threshold
            expression: B
            refId: C
            conditions:
              - evaluator:
                  params: [5]
                  type: gt
                operator:
                  type: and
                query:
                  params: [C]
                reducer:
                  type: last
                type: query

    # Alert: Hard Limit Reached (FIXED)
    - uid: fly-hard-limit-reached
      title: "Hard Limit Reached (CRITICAL)"
      condition: C # Changed from B to C
      for: 1m
      noDataState: NoData
      execErrState: Alerting
      annotations:
        summary: "App hard concurrency limit reached"
        description: "App is rejecting connections at hard limit. Scale immediately!"
      #        __dashboardUid__: "fly-app"
      labels:
        severity: "critical"
        alertname: "HardLimitReached"
        team: "platform"
        service: "fly-io"
      data:
        - refId: A
          datasourceUid: prometheus_on_fly
          relativeTimeRange:
            from: 600
            to: 0
          model:
            expr: "sum(increase(fly_app_hard_limit_reached_count[5m]))"
            refId: A
        - refId: B
          datasourceUid: __expr__
          model:
            type: reduce
            expression: A
            reducer: last
            refId: B
        - refId: C
          datasourceUid: __expr__
          model:
            type: threshold
            expression: B
            refId: C
            conditions:
              - evaluator:
                  params: [0]
                  type: gt
                operator:
                  type: and
                query:
                  params: [C]
                reducer:
                  type: last
                type: query

---
apiVersion: grafana.integreatly.org/v1beta1
kind: GrafanaAlertRuleGroup
metadata:
  name: fly-infrastructure-alerts

spec:
  instanceSelector:
    matchLabels:
      grafana.internal/instance: grafana

  folderRef: "external-folder"
  interval: 1m
  name: "Fly Infrastructure - Resources"

  rules:
    # Alert: Memory Available < 10%
    - uid: fly-memory-critical
      title: "Memory Available < 10%"
      condition: C
      for: 5m
      noDataState: NoData
      execErrState: Alerting
      annotations:
        summary: "Critical memory shortage on {{ $labels.app }} instance {{ $labels.instance }}"
        description: "Available memory is {{ $values.C.Value | humanize }}% - Escalate to infrastructure team"
      #        __dashboardUid__: "fly-instance"
      labels:
        severity: "critical"
        alertname: "LowMemoryAvailable"
        team: "infrastructure"
        service: "fly-io"
        escalate: "true"
      data:
        - refId: A
          datasourceUid: prometheus_on_fly
          relativeTimeRange:
            from: 600
            to: 0
          model:
            expr: "(fly_instance_memory_mem_available / fly_instance_memory_mem_total) * 100"
            refId: A
        - refId: B
          datasourceUid: __expr__
          model:
            type: reduce
            expression: A
            reducer: last
            refId: B
        - refId: C
          datasourceUid: __expr__
          model:
            type: threshold
            expression: B
            refId: C
            conditions:
              - evaluator:
                  params: [10]
                  type: lt
                operator:
                  type: and
                query:
                  params: [C]
                reducer:
                  type: last
                type: query

    # Alert: Disk Space Critical > 90%
    - uid: fly-disk-critical
      title: "Disk Space Critical > 90%"
      condition: C
      for: 10m
      noDataState: NoData
      execErrState: Alerting
      annotations:
        summary: "Disk space critical on {{ $labels.app }} instance {{ $labels.instance }}"
        description: "Root filesystem usage is {{ $values.C.Value | humanize }}% - Immediate action required"
      #        __dashboardUid__: "fly-instance"
      labels:
        severity: "critical"
        alertname: "HighDiskUsage"
        team: "infrastructure"
        service: "fly-io"
      data:
        - refId: A
          datasourceUid: prometheus_on_fly
          relativeTimeRange:
            from: 600
            to: 0
          model:
            expr: '((fly_instance_filesystem_blocks{mount="/.fly-upper-layer"} - fly_instance_filesystem_blocks_avail{mount="/.fly-upper-layer"}) / fly_instance_filesystem_blocks{mount="/.fly-upper-layer"}) * 100'
            refId: A
        - refId: B
          datasourceUid: __expr__
          model:
            type: reduce
            expression: A
            reducer: last
            refId: B
        - refId: C
          datasourceUid: __expr__
          model:
            type: threshold
            expression: B
            refId: C
            conditions:
              - evaluator:
                  params: [90]
                  type: gt
                operator:
                  type: and
                query:
                  params: [C]
                reducer:
                  type: last
                type: query

    # Alert: Fly Volume High Usage
    - uid: fly-volume-high-usage
      title: "Fly Volume High Usage"
      condition: C
      for: 10m
      noDataState: NoData
      execErrState: Alerting
      annotations:
        summary: "Fly volume {{ $labels.mount }} usage is high"
        description: "Volume usage is {{ $values.C.Value | humanize }}% on {{ $labels.instance }}"
        __dashboardUid__: "fly-instance"
      labels:
        severity: "warning"
        alertname: "HighVolumeUsage"
        team: "infrastructure"
        service: "fly-io"
      data:
        - refId: A
          datasourceUid: prometheus_on_fly
          relativeTimeRange:
            from: 600
            to: 0
          model:
            expr: '((fly_instance_filesystem_blocks{mount!="/",mount!="/.fly-upper-layer"} - fly_instance_filesystem_blocks_avail{mount!="/",mount!="/.fly-upper-layer"}) / fly_instance_filesystem_blocks{mount!="/",mount!="/.fly-upper-layer"}) * 100'
            refId: A
        - refId: B
          datasourceUid: __expr__
          model:
            type: reduce
            expression: A
            reducer: last
            refId: B
        - refId: C
          datasourceUid: __expr__
          model:
            type: threshold
            expression: B
            refId: C
            conditions:
              - evaluator:
                  params: [85]
                  type: gt
                operator:
                  type: and
                query:
                  params: [C]
                reducer:
                  type: last
                type: query

    # Alert: CPU Throttling
    - uid: fly-cpu-throttling
      title: "CPU Throttling Detected"
      condition: C
      for: 5m
      noDataState: NoData
      execErrState: Alerting
      annotations:
        summary: "CPU throttling detected on {{ $labels.app }} instance {{ $labels.instance }}"
        description: "CPU is being throttled at {{ $values.C.Value | humanizePercentage }}"
      #        __dashboardUid__: "fly-instance"
      labels:
        severity: "critical"
        alertname: "CPUThrottling"
        team: "infrastructure"
        service: "fly-io"
      data:
        - refId: A
          datasourceUid: prometheus_on_fly
          relativeTimeRange:
            from: 600
            to: 0
          model:
            expr: 'rate(fly_instance_cpu_throttle[5m]) / count without(cpu) (fly_instance_cpu{mode="idle"})'
            refId: A
        - refId: B
          datasourceUid: __expr__
          model:
            type: reduce
            expression: A
            reducer: last
            refId: B
        - refId: C
          datasourceUid: __expr__
          model:
            type: threshold
            expression: B
            refId: C
            conditions:
              - evaluator:
                  params: [0.05]
                  type: gt
                operator:
                  type: and
                query:
                  params: [C]
                reducer:
                  type: last
                type: query

    # Alert: High CPU Utilization
    - uid: fly-instance-high-cpu
      title: "High CPU Utilization"
      condition: C
      for: 5m
      noDataState: NoData
      execErrState: Alerting
      annotations:
        summary: "CPU utilization is high on {{ $labels.instance }}"
        description: "CPU usage is {{ $values.C.Value | humanize }}% - Check recent deployments"
      #        __dashboardUid__: "fly-instance"
      labels:
        severity: "warning"
        alertname: "HighCPUUtilization"
        team: "platform"
        service: "fly-io"
      data:
        - refId: A
          datasourceUid: prometheus_on_fly
          relativeTimeRange:
            from: 600
            to: 0
          model:
            expr: 'sum(rate(fly_instance_cpu{mode!="idle", mode!="steal"}[60s])) by (instance, region) / count(fly_instance_cpu{mode="idle"}) by (instance, region) * 100'
            refId: A
        - refId: B
          datasourceUid: __expr__
          model:
            type: reduce
            expression: A
            reducer: last
            refId: B
        - refId: C
          datasourceUid: __expr__
          model:
            type: threshold
            expression: B
            refId: C
            conditions:
              - evaluator:
                  params: [80]
                  type: gt
                operator:
                  type: and
                query:
                  params: [C]
                reducer:
                  type: last
                type: query

    # Alert: High Load Average
    - uid: fly-load-average-high
      title: "Load Average Exceeds CPU Count"
      condition: C
      for: 10m
      noDataState: NoData
      execErrState: Alerting
      annotations:
        summary: "Load average exceeds CPU count on {{ $labels.instance }}"
        description: "5-minute load average is {{ $values.C.Value | humanize }}x CPU count"
      #        __dashboardUid__: "fly-instance"
      labels:
        severity: "warning"
        alertname: "HighLoadAverage"
        team: "infrastructure"
        service: "fly-io"
      data:
        - refId: A
          datasourceUid: prometheus_on_fly
          relativeTimeRange:
            from: 600
            to: 0
          model:
            expr: 'fly_instance_load_average{minutes="5"} / count without(cpu) (fly_instance_cpu{mode="idle"})'
            refId: A
        - refId: B
          datasourceUid: __expr__
          model:
            type: reduce
            expression: A
            reducer: last
            refId: B
        - refId: C
          datasourceUid: __expr__
          model:
            type: threshold
            expression: B
            refId: C
            conditions:
              - evaluator:
                  params: [1]
                  type: gt
                operator:
                  type: and
                query:
                  params: [C]
                reducer:
                  type: last
                type: query

    # Alert: High CPU IO Wait
    - uid: fly-instance-high-iowait
      title: "High CPU IO Wait"
      condition: C
      for: 10m
      noDataState: NoData
      execErrState: Alerting
      annotations:
        summary: "High CPU IO wait detected"
        description: "IO wait is {{ $values.C.Value | humanize }}% - Disk may be slow"
      #        __dashboardUid__: "fly-instance"
      labels:
        severity: "warning"
        alertname: "HighIOWait"
        team: "infrastructure"
        service: "fly-io"
      data:
        - refId: A
          datasourceUid: prometheus_on_fly
          relativeTimeRange:
            from: 600
            to: 0
          model:
            expr: 'sum(rate(fly_instance_cpu{mode="iowait"}[5m])) by (instance, region) * 100'
            refId: A
        - refId: B
          datasourceUid: __expr__
          model:
            type: reduce
            expression: A
            reducer: last
            refId: B
        - refId: C
          datasourceUid: __expr__
          model:
            type: threshold
            expression: B
            refId: C
            conditions:
              - evaluator:
                  params: [20]
                  type: gt
                operator:
                  type: and
                query:
                  params: [C]
                reducer:
                  type: last
                type: query

    # Alert: High File Descriptor Usage
    - uid: fly-high-fd-usage
      title: "High File Descriptor Usage"
      condition: D
      for: 5m
      noDataState: NoData
      execErrState: Alerting
      annotations:
        summary: "High file descriptor usage"
        description: "File descriptor usage is {{ $values.D.Value | humanize }}% - May cause connection failures"
      #        __dashboardUid__: "fly-instance"
      labels:
        severity: "critical"
        alertname: "HighFileDescriptors"
        team: "infrastructure"
        service: "fly-io"
      data:
        - refId: A
          datasourceUid: prometheus_on_fly
          relativeTimeRange:
            from: 600
            to: 0
          model:
            expr: "fly_instance_filefd_allocated"
            refId: A
        - refId: B
          datasourceUid: prometheus_on_fly
          relativeTimeRange:
            from: 600
            to: 0
          model:
            expr: "fly_instance_filefd_maximum"
            refId: B
        - refId: C
          datasourceUid: __expr__
          model:
            type: math
            expression: "$A / $B * 100"
            refId: C
        - refId: D
          datasourceUid: __expr__
          model:
            type: threshold
            expression: C
            refId: D
            conditions:
              - evaluator:
                  params: [80]
                  type: gt
                operator:
                  type: and
                query:
                  params: [D]
                reducer:
                  type: last
                type: query

    # Alert: High Disk I/O Utilization
    - uid: fly-high-disk-io
      title: "High Disk I/O Utilization"
      condition: C
      for: 10m
      noDataState: NoData
      execErrState: Alerting
      annotations:
        summary: "High disk I/O utilization"
        description: "Disk I/O utilization above 80% - Storage may be bottleneck"
      #        __dashboardUid__: "fly-instance"
      labels:
        severity: "warning"
        alertname: "HighDiskIOUtilization"
        team: "infrastructure"
        service: "fly-io"
      data:
        - refId: A
          datasourceUid: prometheus_on_fly
          relativeTimeRange:
            from: 600
            to: 0
          model:
            expr: "rate(fly_instance_disk_time_io[5m]) / 1000"
            refId: A
        - refId: B
          datasourceUid: __expr__
          model:
            type: reduce
            expression: A
            reducer: last
            refId: B
        - refId: C
          datasourceUid: __expr__
          model:
            type: threshold
            expression: B
            refId: C
            conditions:
              - evaluator:
                  params: [0.8]
                  type: gt
                operator:
                  type: and
                query:
                  params: [C]
                reducer:
                  type: last
                type: query

    # Alert: High Disk Queue Depth
    - uid: fly-high-disk-queue
      title: "High Disk Queue Depth"
      condition: C
      for: 10m
      noDataState: NoData
      execErrState: Alerting
      annotations:
        summary: "High disk queue depth"
        description: "Disk queue depth is high - I/O backlog accumulating"
      #        __dashboardUid__: "fly-instance"
      labels:
        severity: "warning"
        alertname: "HighDiskQueueDepth"
        team: "infrastructure"
        service: "fly-io"
      data:
        - refId: A
          datasourceUid: prometheus_on_fly
          relativeTimeRange:
            from: 600
            to: 0
          model:
            expr: "rate(fly_instance_disk_time_io_weighted[5m]) / 1000"
            refId: A
        - refId: B
          datasourceUid: __expr__
          model:
            type: reduce
            expression: A
            reducer: last
            refId: B
        - refId: C
          datasourceUid: __expr__
          model:
            type: threshold
            expression: B
            refId: C
            conditions:
              - evaluator:
                  params: [10]
                  type: gt
                operator:
                  type: and
                query:
                  params: [C]
                reducer:
                  type: last
                type: query
---
apiVersion: grafana.integreatly.org/v1beta1
kind: GrafanaAlertRuleGroup
metadata:
  name: fly-network-edge-alerts

spec:
  instanceSelector:
    matchLabels:
      grafana.internal/instance: grafana

  folderRef: "external-folder"
  interval: 1m
  name: "Fly Network & Edge"

  rules:
    # Alert: TLS SNI Limit Reached
    - uid: fly-tls-sni-limit
      title: "TLS SNI Limit Reached"
      condition: C
      for: 5m
      noDataState: NoData
      execErrState: Alerting
      annotations:
        summary: "TLS SNI concurrency limit reached for {{ $labels.servername }}"
        description: "TLS handshakes queued due to SNI limits. Possible targeted attack."
        __dashboardUid__: "fly-edge"
      labels:
        severity: "critical"
        alertname: "TLSSNILimit"
        team: "platform"
        service: "fly-io"
      data:
        - refId: A
          datasourceUid: prometheus_on_fly
          relativeTimeRange:
            from: 600
            to: 0
          model:
            expr: "sum by(servername) (increase(fly_edge_tls_sni_limit_reached_count[5m])) > 0"
            refId: A
        - refId: B
          datasourceUid: __expr__
          model:
            type: reduce
            expression: A
            reducer: last
            refId: B
        - refId: C
          datasourceUid: __expr__
          model:
            type: threshold
            expression: B
            refId: C
            conditions:
              - evaluator:
                  params: [0]
                  type: gt
                operator:
                  type: and
                query:
                  params: [C]
                reducer:
                  type: last
                type: query
    # Alert: Network Packet Drops/Errors
    - uid: fly-network-errors
      title: "Network Packet Drops/Errors"
      condition: C
      for: 5m
      noDataState: NoData
      execErrState: Alerting
      annotations:
        summary: "Network issues detected on {{ $labels.app }} instance {{ $labels.instance }}"
        description: "Network drops/errors at {{ $values.C.Value | humanize }} packets/sec"
      #        __dashboardUid__: "fly-instance"
      labels:
        severity: "warning"
        alertname: "NetworkPacketDrops"
        team: "infrastructure"
        service: "fly-io"
      data:
        - refId: A
          datasourceUid: prometheus_on_fly
          relativeTimeRange:
            from: 600
            to: 0
          model:
            expr: 'sum by(app, instance) (rate(fly_instance_net_recv_drop{device="eth0"}[5m]) + rate(fly_instance_net_sent_drop{device="eth0"}[5m]) + rate(fly_instance_net_recv_errs{device="eth0"}[5m]) + rate(fly_instance_net_sent_errs{device="eth0"}[5m]))'
            refId: A
        - refId: B
          datasourceUid: __expr__
          model:
            type: reduce
            expression: A
            reducer: last
            refId: B
        - refId: C
          datasourceUid: __expr__
          model:
            type: threshold
            expression: B
            refId: C
            conditions:
              - evaluator:
                  params: [1]
                  type: gt
                operator:
                  type: and
                query:
                  params: [C]
                reducer:
                  type: last
                type: query

    # Alert: TLS Handshake Errors
    - uid: fly-tls-handshake-errors
      title: "TLS Handshake Errors"
      condition: C
      for: 5m
      noDataState: NoData
      execErrState: Alerting
      annotations:
        summary: "TLS handshake errors on edge host {{ $labels.host }}"
        description: "{{ $values.C.Value | humanize }} TLS handshake errors - Reason: {{ $labels.reason }}"
      #        __dashboardUid__: "fly-edge"
      labels:
        severity: "critical"
        alertname: "TLSHandshakeErrors"
        team: "platform"
        service: "fly-io"
      data:
        - refId: A
          datasourceUid: prometheus_on_fly
          relativeTimeRange:
            from: 600
            to: 0
          model:
            expr: "sum by(host, reason) (increase(fly_edge_tls_handshake_errors[5m]))"
            refId: A
        - refId: B
          datasourceUid: __expr__
          model:
            type: reduce
            expression: A
            reducer: last
            refId: B
        - refId: C
          datasourceUid: __expr__
          model:
            type: threshold
            expression: B
            refId: C
            conditions:
              - evaluator:
                  params: [10]
                  type: gt
                operator:
                  type: and
                query:
                  params: [C]
                reducer:
                  type: last
                type: query

    # Alert: Edge High 5xx Response Rate
    - uid: fly-edge-5xx-rate
      title: "Edge High 5xx Response Rate"
      condition: D
      for: 5m
      noDataState: NoData
      execErrState: Alerting
      annotations:
        summary: "Edge 5xx error rate above threshold"
        description: "Edge 5xx error rate is {{ $values.D.Value | humanize }}% - Check edge proxy and backend health"
      #        __dashboardUid__: "fly-edge"
      labels:
        severity: "critical"
        alertname: "EdgeHigh5xxRate"
        team: "platform"
        service: "fly-io"
      data:
        - refId: A
          datasourceUid: prometheus_on_fly
          relativeTimeRange:
            from: 600
            to: 0
          model:
            expr: 'sum(increase(fly_edge_http_responses_count{status=~"5.."}[5m]))'
            refId: A
        - refId: B
          datasourceUid: prometheus_on_fly
          relativeTimeRange:
            from: 600
            to: 0
          model:
            expr: "sum(increase(fly_edge_http_responses_count[5m]))"
            refId: B
        - refId: C
          datasourceUid: __expr__
          model:
            type: math
            expression: "($A / $B) * 100"
            refId: C
        - refId: D
          datasourceUid: __expr__
          model:
            type: threshold
            expression: C
            refId: D
            conditions:
              - evaluator:
                  params: [5]
                  type: gt
                operator:
                  type: and
                query:
                  params: [D]
                reducer:
                  type: last
                type: query

    # Alert: Edge TCP Rate Limited
    - uid: fly-edge-rate-limited
      title: "Edge Rate Limited"
      condition: C
      for: 5m
      noDataState: NoData
      execErrState: Alerting
      annotations:
        summary: "Edge connections being rate limited"
        description: "Edge is dropping connections due to rate limits - Possible DDoS or need scaling"
      #        __dashboardUid__: "fly-edge"
      labels:
        severity: "critical"
        alertname: "EdgeRateLimited"
        team: "platform"
        service: "fly-io"
      data:
        - refId: A
          datasourceUid: prometheus_on_fly
          relativeTimeRange:
            from: 600
            to: 0
          model:
            expr: "sum by(type, region) (increase(fly_edge_tcp_rate_limited_count[5m]))"
            refId: A
        - refId: B
          datasourceUid: __expr__
          model:
            type: reduce
            expression: A
            reducer: last
            refId: B
        - refId: C
          datasourceUid: __expr__
          model:
            type: threshold
            expression: B
            refId: C
            conditions:
              - evaluator:
                  params: [10]
                  type: gt
                operator:
                  type: and
                query:
                  params: [C]
                reducer:
                  type: last
                type: query

    # Alert: TLS IP Limit Reached
    - uid: fly-tls-ip-limit
      title: "TLS IP Limit Reached"
      condition: C
      for: 5m
      noDataState: NoData
      execErrState: Alerting
      annotations:
        summary: "TLS IP concurrency limit reached"
        description: "TLS handshakes queued due to IP limits - Possible attack"
      #        __dashboardUid__: "fly-edge"
      labels:
        severity: "critical"
        alertname: "TLSIPLimit"
        team: "platform"
        service: "fly-io"
      data:
        - refId: A
          datasourceUid: prometheus_on_fly
          relativeTimeRange:
            from: 600
            to: 0
          model:
            expr: "sum(increase(fly_edge_tls_ip_limit_reached_count[5m])) > 0"
            refId: A
        - refId: B
          datasourceUid: __expr__
          model:
            type: reduce
            expression: A
            reducer: last
            refId: B
        - refId: C
          datasourceUid: __expr__
          model:
            type: threshold
            expression: B
            refId: C
            conditions:
              - evaluator:
                  params: [0]
                  type: gt
                operator:
                  type: and
                query:
                  params: [C]
                reducer:
                  type: last
                type: query

    # Alert: High TCP Connection Rate
    - uid: fly-edge-high-connection-rate
      title: "High TCP Connection Rate"
      condition: C
      for: 5m
      noDataState: NoData
      execErrState: Alerting
      annotations:
        summary: "Unusually high TCP connection rate"
        description: "TCP connection rate is {{ $values.C.Value | humanize }}/sec - Possible traffic spike or DDoS"
      #        __dashboardUid__: "fly-edge"
      labels:
        severity: "warning"
        alertname: "HighTCPConnectionRate"
        team: "platform"
        service: "fly-io"
      data:
        - refId: A
          datasourceUid: prometheus_on_fly
          relativeTimeRange:
            from: 600
            to: 0
          model:
            expr: "sum(rate(fly_edge_tcp_connects_count[5m]))"
            refId: A
        - refId: B
          datasourceUid: __expr__
          model:
            type: reduce
            expression: A
            reducer: last
            refId: B
        - refId: C
          datasourceUid: __expr__
          model:
            type: threshold
            expression: B
            refId: C
            conditions:
              - evaluator:
                  params: [1000]
                  type: gt
                operator:
                  type: and
                query:
                  params: [C]
                reducer:
                  type: last
                type: query

    # Alert: High Connection Churn (FIXED)
    - uid: fly-edge-connection-churn
      title: "High Connection Churn"
      condition: E
      for: 10m
      noDataState: NoData
      execErrState: Alerting
      annotations:
        summary: "High connection churn detected!"
        description: "Connection churn rate is {{ $values.E.Value | humanize }}% - Most connections are short-lived"
        # __dashboardUid__: "fly-edge"
      labels:
        severity: "warning"
        alertname: "HighConnectionChurn"
        team: "platform"
        service: "fly-io"
      data:
        - refId: A
          datasourceUid: prometheus_on_fly
          relativeTimeRange:
            from: 600
            to: 0
          model:
            expr: "sum(rate(fly_edge_tcp_disconnects_count[5m]))"
            refId: A
        - refId: B
          datasourceUid: prometheus_on_fly
          relativeTimeRange:
            from: 600
            to: 0
          model:
            expr: "sum(rate(fly_edge_tcp_connects_count[5m]))"
            refId: B
        - refId: C
          datasourceUid: __expr__
          relativeTimeRange:
            from: 600
            to: 0
          model:
            type: math
            expression: "($A / $B) * 100"
            refId: C
        - refId: D
          datasourceUid: __expr__
          relativeTimeRange:
            from: 600
            to: 0
          model:
            type: reduce
            expression: C
            reducer: last
            refId: D
        - refId: E
          datasourceUid: __expr__
          relativeTimeRange:
            from: 600
            to: 0
          model:
            type: threshold
            expression: D
            refId: E
            conditions:
              - evaluator:
                  params: [80]
                  type: gt
                operator:
                  type: and
                query:
                  params: [E]
                reducer:
                  type: last
                type: query

    # Alert: High Edge Data Transfer
    - uid: fly-high-edge-data
      title: "High Edge Data Transfer"
      condition: C
      for: 10m
      noDataState: NoData
      execErrState: Alerting
      annotations:
        summary: "High edge data transfer detected"
        description: "Edge data transfer is {{ $values.C.Value | humanize }} bytes/sec - Monitor bandwidth costs"
      #        __dashboardUid__: "fly-edge"
      labels:
        severity: "info"
        alertname: "HighEdgeDataTransfer"
        team: "platform"
        service: "fly-io"
      data:
        - refId: A
          datasourceUid: prometheus_on_fly
          relativeTimeRange:
            from: 600
            to: 0
          model:
            expr: "sum(rate(fly_edge_data_in[5m])) + sum(rate(fly_edge_data_out[5m]))"
            refId: A
        - refId: B
          datasourceUid: __expr__
          model:
            type: reduce
            expression: A
            reducer: last
            refId: B
        - refId: C
          datasourceUid: __expr__
          model:
            type: threshold
            expression: B
            refId: C
            conditions:
              - evaluator:
                  params: [1000000000]
                  type: gt
                operator:
                  type: and
                query:
                  params: [C]
                reducer:
                  type: last
                type: query

    # Alert: High Instance Network Transfer
    - uid: fly-instance-high-network
      title: "High Instance Network Transfer"
      condition: C
      for: 10m
      noDataState: NoData
      execErrState: Alerting
      annotations:
        summary: "High network traffic on instance"
        description: "Network transfer is {{ $values.C.Value | humanize }} bytes/sec - Monitor bandwidth usage"
      #        __dashboardUid__: "fly-instance"
      labels:
        severity: "info"
        alertname: "HighInstanceNetworkTransfer"
        team: "platform"
        service: "fly-io"
      data:
        - refId: A
          datasourceUid: prometheus_on_fly
          relativeTimeRange:
            from: 600
            to: 0
          model:
            expr: 'sum(rate(fly_instance_net_sent_bytes{device="eth0"}[5m])) + sum(rate(fly_instance_net_recv_bytes{device="eth0"}[5m]))'
            refId: A
        - refId: B
          datasourceUid: __expr__
          model:
            type: reduce
            expression: A
            reducer: last
            refId: B
        - refId: C
          datasourceUid: __expr__
          model:
            type: threshold
            expression: B
            refId: C
            conditions:
              - evaluator:
                  params: [104857600]
                  type: gt
                operator:
                  type: and
                query:
                  params: [C]
                reducer:
                  type: last
                type: query
