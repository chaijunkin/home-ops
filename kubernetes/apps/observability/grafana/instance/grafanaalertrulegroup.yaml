---
apiVersion: grafana.integreatly.org/v1beta1
kind: GrafanaAlertRuleGroup
metadata:
  name: fly-app-alerts
  namespace: observability
spec:
  instanceSelector:
    matchLabels:
      grafana.internal/instance: grafana

  folderRef: "external-folder"
  interval: 1m
  name: "Fly.io App Monitoring"

  rules:
    # === Instance-Level Alerts ===

    # 1. High Disk Usage
    - uid: fly-high-disk-usage
      title: "Fly - High Disk Usage"
      condition: E
      data:
        - refId: A
          relativeTimeRange:
            from: 600
            to: 0
          datasourceUid: prometheus_on_fly
          model:
            expr: |
              fly_instance_filesystem_blocks{mount="/.fly-upper-layer"} *
              fly_instance_filesystem_block_size{mount="/.fly-upper-layer"}
            refId: A
        - refId: B
          relativeTimeRange:
            from: 600
            to: 0
          datasourceUid: prometheus_on_fly
          model:
            expr: |
              fly_instance_filesystem_blocks_avail{mount="/.fly-upper-layer"} *
              fly_instance_filesystem_block_size{mount="/.fly-upper-layer"}
            refId: B
        - refId: C
          datasourceUid: "-100"
          model:
            type: math
            refId: C
            expression: "($A - $B) / $A * 100"
        - refId: D
          datasourceUid: "-100"
          model:
            type: reduce
            refId: D
            expression: C
            reducer: last
        - refId: E
          datasourceUid: "-100"
          model:
            type: threshold
            refId: E
            expression: D
            conditions:
              - evaluator:
                  params: [85]
                  type: gt
      for: 5m
      noDataState: NoData
      execErrState: Alerting
      annotations:
        summary: "High disk usage on Fly instance"
        description: "Root filesystem usage is above 85%. Clean up or expand storage."
      labels:
        severity: high
        alertname: HighDiskUsage
        job: fly-io
        team: infrastructure
        service: fly-io

    # 2. High Soft Limit Reached
    - uid: fly-soft-limit-reached
      title: "Fly - App Soft Limit Reached"
      condition: B
      data:
        - refId: A
          relativeTimeRange:
            from: 600
            to: 0
          datasourceUid: prometheus_on_fly
          model:
            expr: |
              sum(increase(fly_app_soft_limit_reached_count[5m]))
            refId: A
        - refId: B
          datasourceUid: "-100"
          model:
            type: threshold
            refId: B
            expression: A
            conditions:
              - evaluator:
                  params: [5]
                  type: gt
      for: 5m
      noDataState: NoData
      execErrState: Alerting
      annotations:
        summary: "App soft concurrency limit reached"
        description: "App is hitting soft limits. Consider scaling."
      labels:
        severity: warning
        alertname: SoftLimitReached
        job: fly-io
        team: platform
        service: fly-io

    # 3. Hard Limit Reached (Critical)
    - uid: fly-hard-limit-reached
      title: "Fly - App Hard Limit Reached"
      condition: B
      data:
        - refId: A
          relativeTimeRange:
            from: 600
            to: 0
          datasourceUid: prometheus_on_fly
          model:
            expr: |
              sum(increase(fly_app_hard_limit_reached_count[5m]))
            refId: A
        - refId: B
          datasourceUid: "-100"
          model:
            type: threshold
            refId: B
            expression: A
            conditions:
              - evaluator:
                  params: [0]
                  type: gt
      for: 1m
      noDataState: NoData
      execErrState: Alerting
      annotations:
        summary: "App hard concurrency limit reached"
        description: "App is rejecting connections at hard limit. Scale immediately."
      labels:
        severity: critical
        alertname: HardLimitReached
        job: fly-io
        team: platform
        service: fly-io

    # 4. High File Descriptor Usage
    - uid: fly-high-fd-usage
      title: "Fly - High File Descriptor Usage"
      condition: E
      data:
        - refId: A
          relativeTimeRange:
            from: 600
            to: 0
          datasourceUid: prometheus_on_fly
          model:
            expr: |
              fly_instance_filefd_allocated
            refId: A
        - refId: B
          relativeTimeRange:
            from: 600
            to: 0
          datasourceUid: prometheus_on_fly
          model:
            expr: |
              fly_instance_filefd_maximum
            refId: B
        - refId: C
          datasourceUid: "-100"
          model:
            type: math
            refId: C
            expression: "$A / $B * 100"
        - refId: D
          datasourceUid: "-100"
          model:
            type: reduce
            refId: D
            expression: C
            reducer: last
        - refId: E
          datasourceUid: "-100"
          model:
            type: threshold
            refId: E
            expression: D
            conditions:
              - evaluator:
                  params: [80]
                  type: gt
      for: 5m
      noDataState: NoData
      execErrState: Alerting
      annotations:
        summary: "High file descriptor usage"
        description: "File descriptor usage is above 80%. May cause connection failures."
      labels:
        severity: high
        alertname: HighFileDescriptors
        job: fly-io
        team: infrastructure
        service: fly-io

    # 5. Network Packet Drops
    - uid: fly-network-drops
      title: "Fly - Network Packet Drops"
      condition: C
      data:
        - refId: A
          relativeTimeRange:
            from: 600
            to: 0
          datasourceUid: prometheus_on_fly
          model:
            expr: |
              sum(rate(fly_instance_net_recv_drop{device="eth0"}[5m])) +
              sum(rate(fly_instance_net_sent_drop{device="eth0"}[5m]))
            refId: A
        - refId: B
          datasourceUid: "-100"
          model:
            type: reduce
            refId: B
            expression: A
            reducer: last
        - refId: C
          datasourceUid: "-100"
          model:
            type: threshold
            refId: C
            expression: B
            conditions:
              - evaluator:
                  params: [10]
                  type: gt
      for: 5m
      noDataState: NoData
      execErrState: Alerting
      annotations:
        summary: "Network packets being dropped"
        description: "Network packet drops detected. Check network health."
      labels:
        severity: warning
        alertname: NetworkPacketDrops
        job: fly-io
        team: infrastructure
        service: fly-io

    # 6. High Disk I/O Utilization
    - uid: fly-high-disk-io
      title: "Fly - High Disk I/O Utilization"
      condition: C
      data:
        - refId: A
          relativeTimeRange:
            from: 600
            to: 0
          datasourceUid: prometheus_on_fly
          model:
            expr: |
              rate(fly_instance_disk_time_io[5m]) / 1000
            refId: A
        - refId: B
          datasourceUid: "-100"
          model:
            type: reduce
            refId: B
            expression: A
            reducer: last
        - refId: C
          datasourceUid: "-100"
          model:
            type: threshold
            refId: C
            expression: B
            conditions:
              - evaluator:
                  params: [0.8]
                  type: gt
      for: 10m
      noDataState: NoData
      execErrState: Alerting
      annotations:
        summary: "High disk I/O utilization"
        description: "Disk I/O utilization above 80%. Storage may be bottleneck."
      labels:
        severity: warning
        alertname: HighDiskIOUtilization
        job: fly-io
        team: infrastructure
        service: fly-io

    # 7. High Disk Queue Depth
    - uid: fly-high-disk-queue
      title: "Fly - High Disk Queue Depth"
      condition: C
      data:
        - refId: A
          relativeTimeRange:
            from: 600
            to: 0
          datasourceUid: prometheus_on_fly
          model:
            expr: |
              rate(fly_instance_disk_time_io_weighted[5m]) / 1000
            refId: A
        - refId: B
          datasourceUid: "-100"
          model:
            type: reduce
            refId: B
            expression: A
            reducer: last
        - refId: C
          datasourceUid: "-100"
          model:
            type: threshold
            refId: C
            expression: B
            conditions:
              - evaluator:
                  params: [10]
                  type: gt
      for: 10m
      noDataState: NoData
      execErrState: Alerting
      annotations:
        summary: "High disk queue depth"
        description: "Disk queue depth is high. I/O backlog accumulating."
      labels:
        severity: warning
        alertname: HighDiskQueueDepth
        job: fly-io
        team: infrastructure
        service: fly-io

    # === Edge-Level Alerts ===

    # 8. Edge TCP Rate Limited
    - uid: fly-edge-rate-limited
      title: "Fly - Edge Rate Limited"
      condition: C
      data:
        - refId: A
          relativeTimeRange:
            from: 600
            to: 0
          datasourceUid: prometheus_on_fly
          model:
            expr: |
              sum by(type, region) (
                increase(fly_edge_tcp_rate_limited_count[5m])
              )
            refId: A
        - refId: B
          datasourceUid: "-100"
          model:
            type: reduce
            refId: B
            expression: A
            reducer: last
        - refId: C
          datasourceUid: "-100"
          model:
            type: threshold
            refId: C
            expression: B
            conditions:
              - evaluator:
                  params: [10]
                  type: gt
      for: 5m
      noDataState: NoData
      execErrState: Alerting
      annotations:
        summary: "Edge connections being rate limited"
        description: "Edge is dropping connections due to rate limits. Possible DDoS or need scaling."
      labels:
        severity: high
        alertname: EdgeRateLimited
        job: fly-io
        team: platform
        service: fly-io

    # 9. High Edge Data Transfer
    - uid: fly-high-edge-data
      title: "Fly - High Edge Data Transfer"
      condition: C
      data:
        - refId: A
          relativeTimeRange:
            from: 600
            to: 0
          datasourceUid: prometheus_on_fly
          model:
            expr: |
              sum(rate(fly_edge_data_in[5m])) + sum(rate(fly_edge_data_out[5m]))
            refId: A
        - refId: B
          datasourceUid: "-100"
          model:
            type: reduce
            refId: B
            expression: A
            reducer: last
        - refId: C
          datasourceUid: "-100"
          model:
            type: threshold
            refId: C
            expression: B
            conditions:
              - evaluator:
                  params: [1000000000]
                  type: gt
      for: 10m
      noDataState: NoData
      execErrState: Alerting
      annotations:
        summary: "High edge data transfer"
        description: "Edge data transfer exceeds 1GB/s. Monitor bandwidth costs."
      labels:
        severity: info
        alertname: HighEdgeDataTransfer
        job: fly-io
        team: platform
        service: fly-io

    # 10. TLS IP Limit Reached
    - uid: fly-tls-ip-limit
      title: "Fly - TLS IP Limit Reached"
      condition: C
      data:
        - refId: A
          relativeTimeRange:
            from: 600
            to: 0
          datasourceUid: prometheus_on_fly
          model:
            expr: |
              sum(increase(fly_edge_tls_ip_limit_reached_count[5m])) > 0
            refId: A
        - refId: B
          datasourceUid: "-100"
          model:
            type: reduce
            refId: B
            expression: A
            reducer: last
        - refId: C
          datasourceUid: "-100"
          model:
            type: threshold
            refId: C
            expression: B
            conditions:
              - evaluator:
                  params: [0]
                  type: gt
      for: 5m
      noDataState: NoData
      execErrState: Alerting
      annotations:
        summary: "TLS IP concurrency limit reached"
        description: "TLS handshakes queued due to IP limits. Possible attack."
      labels:
        severity: high
        alertname: TLSIPLimit
        job: fly-io
        team: platform
        service: fly-io
